# ===========================================================================
# Local development overrides
#
# Automatically loaded by `docker compose up` alongside docker-compose.yml.
# Exposes service ports directly and enables live code mounts / debug settings.
# ===========================================================================

services:

  # Disable Caddy in local dev
  caddy:
    profiles:
      - production

  django:
    ports:
      - "8010:8000"
    environment:
      - DJANGO_DEBUG=True
      - DJANGO_SETTINGS_MODULE=sparql_app.settings
      - DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,django,knowbrow-django-1,icfoods.localhost,ic-foods.localhost
      - DJANGO_CSRF_TRUSTED_ORIGINS=http://localhost:8010,http://127.0.0.1:8010
      - DJANGO_CORS_ALLOWED_ORIGINS=http://localhost:3002,http://localhost:3003,http://localhost:3004
      - WAGTAILADMIN_BASE_URL=http://localhost:8010
      - OAUTH_FRONTEND_REDIRECT_URL=http://localhost:3002
      - OAUTH_FRONTEND_REDIRECT_ALLOWLIST=http://localhost:3002
      - FRONTEND_BASE_URL=http://localhost:3002
      - WAGTAIL_THEME_CSS_URL=http://localhost:3002/wagtail-theme/icfoods-wagtail.css
      - FRONTEND_TEMPLATES_DIR=/app/frontend/wagtail-theme/templates
      - FRONTEND_STATIC_DIR=/app/frontend/public
    volumes:
      - ./backend/django:/app
      - ../ic-foods-cms:/app/frontend:ro
    entrypoint: []
    command: ["python", "manage.py", "runserver", "0.0.0.0:8000"]
    healthcheck:
      start_period: 45s

  fastapi:
    ports:
      - "8001:8000"
    environment:
      - ALLOWED_ORIGINS=http://localhost:3002,http://localhost:3003,http://localhost:3004,http://localhost:5173,http://localhost:5174
      - ONTOP_AUTO_RESTART=true
      - DJANGO_USER=${DJANGO_SUPERUSER_USERNAME:-admin}
      - DJANGO_PASSWORD=${DJANGO_SUPERUSER_PASSWORD:-admin123}
    volumes:
      - ./backend/fastapi:/app
      - ontop_runtime:/ontop/runtime
      - /var/run/docker.sock:/var/run/docker.sock

  db:
    ports:
      - "5432:5432"

  oxigraph:
    ports:
      - "7878:7878"

  # IC-FOODS CMS frontend (tenant frontend used by Wagtail live-page links)
  ic-foods-cms:
    build:
      context: ../ic-foods-cms
      dockerfile: Dockerfile
    ports:
      - "3002:3000"
    environment:
      - VITE_API_BASE_URL=http://localhost:8010
      - VITE_CMS_API_URL=http://localhost:8010
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "3000"]
    depends_on:
      django:
        condition: service_started
    networks:
      - backend

  # GraphMap frontend
  graphmap:
    build:
      context: ../graphmap
      dockerfile: Dockerfile
    ports:
      - "3003:80"
    depends_on:
      fastapi:
        condition: service_started
    networks:
      - backend

  # Food Omics Explorer frontend
  food-omics-explorer:
    build:
      context: ../food-omics-explorer
      dockerfile: Dockerfile
    ports:
      - "3004:80"
    networks:
      - backend
